name: PR Code Review con GPT (OpenAI)

# Este workflow se ejecuta autom谩ticamente cuando:
# - Se abre un nuevo PR hacia main
# - Se actualiza un PR existente (nuevos commits)
# - Se reabre un PR cerrado

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  pull_request_review_comment:
    types: [created]

concurrency:
  group:
    ${{ github.repository }}-${{ github.event.number || github.head_ref ||
    github.sha }}-${{ github.workflow }}-${{ github.event_name ==
    'pull_request_review_comment' && 'pr_comment' || 'pr' }}
  cancel-in-progress: ${{ github.event_name != 'pull_request_review_comment' }}

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 obtiene todo el historial de git
          # Necesario para que GPT pueda analizar el contexto completo
          fetch-depth: 0

      - name: Mostrar informaci贸n del PR
        run: |
          echo " Informaci贸n del Pull Request:"
          echo "PR #${{ github.event.pull_request.number }}"
          echo "T铆tulo: ${{ github.event.pull_request.title }}"
          echo "Autor: ${{ github.event.pull_request.user.login }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
          echo "Archivos cambiados: ${{ github.event.pull_request.changed_files }}"

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar gpt-review con dependencias actualizadas
        run: |
          pip install --upgrade pip setuptools wheel
          # Solucionar conflicto de dependencias
          pip uninstall -y typing_extensions || true
          pip install typing_extensions>=4.8.0
          # Instalar gpt-review con todas sus dependencias
          pip install --no-cache-dir gpt-review

      - name: Ejecutar revisi贸n de c贸digo con GPT-4
        run: |
          python .github/scripts/pr_review.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
