name: PR Code Review con GPT (OpenAI)

# Este workflow se ejecuta autom谩ticamente cuando:
# - Se abre un nuevo PR hacia main
# - Se actualiza un PR existente (nuevos commits)
# - Se reabre un PR cerrado
on:
  pull_request:
    branches:
      - main
    types:
      - opened      # PR nuevo
      - synchronize # Nuevos commits en el PR
      - reopened    # PR reabierto

jobs:
  gpt-review:
    runs-on: ubuntu-latest
    # Permisos necesarios para que GPT Review pueda:
    # - Leer el c贸digo (contents: read)
    # - Comentar en el PR (pull-requests: write)
    # - Crear issues si es necesario (issues: write)
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 obtiene todo el historial de git
          # Necesario para que GPT pueda analizar el contexto completo
          fetch-depth: 0

      - name: Mostrar informaci贸n del PR
        run: |
          echo " Informaci贸n del Pull Request:"
          echo "PR #${{ github.event.pull_request.number }}"
          echo "T铆tulo: ${{ github.event.pull_request.title }}"
          echo "Autor: ${{ github.event.pull_request.user.login }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
          echo "Archivos cambiados: ${{ github.event.pull_request.changed_files }}"

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install openai requests

      - name: Ejecutar revisi贸n de c贸digo con GPT-4
        run: |
          python .github/scripts/pr_review.py
        env:
          # IMPORTANTE: Necesitas configurar este secret en GitHub
          # Settings > Secrets and variables > Actions > New repository secret
          # Nombre: OPENAI_API_KEY
          # Valor: Tu API key de OpenAI (obtenerla en https://platform.openai.com/api-keys)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

